name: Deploy to K8s Lab

on:
  push:
    branches: ["main"]
    paths:
      - "k8s/**"
      - ".github/workflows/deploy-lab.yml"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install kubectl (if missing)
        shell: bash
        run: |
          if ! command -v kubectl >/dev/null 2>&1; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
          fi
          kubectl version --client

      - name: Build kubeconfig from secrets
        shell: bash
        run: |
          mkdir -p "$HOME/.kube"
          cat > "$HOME/.kube/config" <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - name: lab
            cluster:
              server: ${K8S_SERVER}
              certificate-authority-data: ${K8S_CA_CRT}
          contexts:
          - name: lab
            context:
              cluster: lab
              user: github-deployer
              namespace: lab
          current-context: lab
          users:
          - name: github-deployer
            user:
              token: ${K8S_TOKEN}
          EOF

      - name: Test cluster access
        shell: bash
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl get ns
          kubectl -n lab get deploy

      - name: Apply Kubernetes manifests
        shell: bash
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl apply -f k8s/deploy-lab.yml
          kubectl -n lab rollout status deploy/nginx --timeout=180s
          kubectl -n lab rollout status deploy/whoami --timeout=180s
          kubectl -n lab rollout status deploy/mysql --timeout=300s

      - name: Show running pods/services
        shell: bash
        run: |
          export KUBECONFIG=$HOME/.kube/config
          kubectl -n lab get pods -o wide
          kubectl -n lab get svc -o wide
        env:
          K8S_SERVER: ${{ secrets.K8S_SERVER }}
          K8S_CA_CRT: ${{ secrets.K8S_CA_CRT }}
          K8S_TOKEN:  ${{ secrets.K8S_TOKEN }}
